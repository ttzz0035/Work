name: Python Quality Pipeline

on: [push]

jobs:
  python-quality:
    runs-on: ubuntu-latest

    steps:
      - name: Check environment
        run: |
          echo "=== Runner Environment ==="
          env | grep GITEA
          echo ""
          echo "=== Working directory ==="
          pwd && ls -la

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: System setup
        run: |
          apt-get update -qq
          apt-get install -y python3-pip graphviz
          pip install --upgrade pip
          pip install pycodestats mypy bandit reuse pytest pytest-cov pylint graphviz

      - name: Static analysis (PEP8, LOC)
        run: |
          echo "### Python Code Metrics" > artifacts_python.md
          pycodestats --by-file . >> artifacts_python.md

      - name: Type checking (mypy)
        run: |
          echo "### Type Checking" >> artifacts_python.md
          mypy . >> artifacts_python.md || true

      - name: Security scan (bandit)
        run: |
          echo "### Security Scan" >> artifacts_python.md
          bandit -r . >> artifacts_python.md || true

      - name: License compliance (reuse)
        run: |
          echo "### License Check" >> artifacts_python.md
          reuse lint >> artifacts_python.md || true

      - name: Test coverage
        run: |
          echo "### Test Results" >> artifacts_python.md
          pytest --maxfail=1 --disable-warnings -q --cov=. >> artifacts_python.md || true

      - name: Display summary
        if: always()
        run: cat artifacts_python.md

      - name: Generate UML (DOT files)
        run: |
          pyreverse -o dot -p ProjectName $(find . -name "*.py" -not -path "./venv/*" -not -path "./tests/*")
          echo "Generated UML files:"
          find . -name "*.dot"

      - name: Upload UML artifacts
        uses: actions/upload-artifact@v3
        with:
          name: uml-dot
          path: |
            **/classes_ProjectName.dot
            **/packages_ProjectName.dot

      - name: Upload Python analysis report
        uses: actions/upload-artifact@v3
        with:
          name: python-quality-report
          path: artifacts_python.md
