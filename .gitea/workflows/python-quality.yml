name: Python Quality Pipeline

on: [push]

jobs:
  python-quality:
    runs-on: ubuntu-latest

    steps:
      # --- ç’°å¢ƒç¢ºèª ---
      - name: Check environment
        run: |
          echo "=== Runner Environment ==="
          env | grep GITEA || true
          echo ""
          echo "=== Working directory ==="
          pwd && ls -la

      # --- ã‚³ãƒ¼ãƒ‰å–å¾— ---
      - name: Checkout repository
        uses: actions/checkout@v3

      # --- ç’°å¢ƒæ§‹ç¯‰ ---
      - name: System setup
        run: |
          apt-get update -qq
          apt-get install -y python3-pip graphviz
          pip install --upgrade pip
          pip install pycodestats mypy bandit reuse pytest pytest-cov coverage pylint graphviz

      # --- é™çš„è§£æï¼ˆPEP8, LOCï¼‰ ---
      - name: Static analysis (PEP8, LOC)
        run: |
          echo "## ğŸ§® Python Code Metrics" > artifacts_python.md
          pycodestats --by-file . >> artifacts_python.md

      # --- å‹ãƒã‚§ãƒƒã‚¯ ---
      - name: Type checking (mypy)
        run: |
          echo "" >> artifacts_python.md
          echo "## ğŸ§© Type Checking" >> artifacts_python.md
          mypy . >> artifacts_python.md 2>&1 || echo "Type check: failed or warnings" >> artifacts_python.md

      # --- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ ---
      - name: Security scan (bandit)
        run: |
          echo "" >> artifacts_python.md
          echo "## ğŸ”’ Security Scan" >> artifacts_python.md
          bandit -r . >> artifacts_python.md 2>&1 || echo "Security scan: issues detected" >> artifacts_python.md

      # --- ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ¤œè¨¼ ---
      - name: License compliance (reuse)
        run: |
          echo "" >> artifacts_python.md
          echo "## âš–ï¸ License Check" >> artifacts_python.md
          reuse lint >> artifacts_python.md 2>&1 || echo "License issues detected" >> artifacts_python.md

      # --- å˜ä½“ãƒ†ã‚¹ãƒˆï¼‹ã‚«ãƒãƒ¬ãƒƒã‚¸ ---
      - name: Unit test & coverage
        run: |
          echo "" >> artifacts_python.md
          echo "## ğŸ§ª Test & Coverage" >> artifacts_python.md
          echo "### Test discovery:" >> artifacts_python.md
          find . -type f -name "test_*.py" -o -name "*_test.py" >> artifacts_python.md || echo "No test files found." >> artifacts_python.md
          echo "" >> artifacts_python.md
          pytest --maxfail=1 --disable-warnings --cov=. --cov-report=term-missing -vv >> artifacts_python.md 2>&1 || echo "Tests failed or no coverage data" >> artifacts_python.md
          echo "" >> artifacts_python.md
          coverage report -m >> artifacts_python.md 2>&1 || true

      # --- çµæœè¡¨ç¤º ---
      - name: Display summary
        if: always()
        run: cat artifacts_python.md

      # --- UMLç”Ÿæˆ ---
      - name: Generate UML (DOT files)
        run: |
          pyreverse -o dot -p ProjectName $(find . -name "*.py" -not -path "./venv/*" -not -path "./tests/*")
          echo "Generated UML files:"
          find . -name "*.dot"

      # --- æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ---
      - name: Upload Python Quality Report
        uses: actions/upload-artifact@v3
        with:
          name: python-quality-report
          path: artifacts_python.md

      - name: Upload UML artifacts
        uses: actions/upload-artifact@v3
        with:
          name: uml-dot
          path: |
            **/classes_ProjectName.dot
            **/packages_ProjectName.dot
