name: Python Quality Intelligence Pipeline

on: [push]

jobs:
  python-quality:
    runs-on: ubuntu-latest

    env:
      COVERAGE_LEVEL: C1  # C0=å‘½ä»¤ç¶²ç¾…, C1=åˆ†å²ç¶²ç¾…, C2=æ¡ä»¶ç¶²ç¾…

    steps:
      # --- Python 3.10 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---
      - name: Install Python 3.10
        run: |
          echo "=== ğŸ§  Python Environment Setup ==="
          apt-get update -qq
          DEBIAN_FRONTEND=noninteractive apt-get install -y python3.10 python3.10-distutils python3.10-venv graphviz licensecheck curl
          update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1
          python3 --version
          curl -sS https://bootstrap.pypa.io/get-pip.py | python3
          pip install --upgrade pip setuptools wheel

      # --- ã‚³ãƒ¼ãƒ‰å–å¾— ---
      - name: Checkout repository
        uses: actions/checkout@v3

      # --- ä¾å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
      - name: Install Analysis Packages
        run: |
          pip install pycodestats mypy bandit pytest pytest-cov coverage pylint graphviz \
                     pip-licenses reuse radon cyclonedx-bom pynguin==0.25.2 MutPy-Pynguin==0.7.1

          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # --- é™çš„ã‚³ãƒ¼ãƒ‰è§£æ ---
      - name: Static code metrics
        run: |
          echo "## ğŸ§® Code Metrics & Complexity" | tee artifacts_python.md
          pycodestats --by-file . | tee -a artifacts_python.md
          echo "" | tee -a artifacts_python.md
          echo "### Cyclomatic Complexity (radon)" | tee -a artifacts_python.md
          radon cc . -s -a | tee -a artifacts_python.md

      # --- å‹è§£æ ---
      - name: Type checking (mypy)
        run: |
          echo "" | tee -a artifacts_python.md
          echo "## ğŸ§© Type Checking" | tee -a artifacts_python.md
          mypy . | tee -a artifacts_python.md || echo "Type check warnings or failures" | tee -a artifacts_python.md

      # --- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è§£æ ---
      - name: Security analysis (bandit)
        run: |
          echo "" | tee -a artifacts_python.md
          echo "## ğŸ”’ Security Analysis" | tee -a artifacts_python.md
          bandit -r . | tee -a artifacts_python.md || echo "Security issues found" | tee -a artifacts_python.md

      # --- è‡ªä½œã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è§£æ ---
      - name: In-repo license scan
        run: |
          echo "" | tee -a artifacts_python.md
          echo "## âš–ï¸ Source License (Repository Files)" | tee -a artifacts_python.md
          licensecheck --recursive --ignore ".git" . | tee -a artifacts_python.md || echo "License header issues detected" | tee -a artifacts_python.md
          echo "" | tee -a artifacts_python.md
          echo "### SPDX Validation (reuse lint)" | tee -a artifacts_python.md
          reuse lint | tee -a artifacts_python.md || echo "SPDX lint: issues detected" | tee -a artifacts_python.md

      # --- ä¾å­˜ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è§£æ ---
      - name: Dependency license scan (pip-licenses)
        run: |
          echo "" | tee -a artifacts_python.md
          echo "## âš–ï¸ Dependency Licenses (External Packages)" | tee -a artifacts_python.md
          pip-licenses --from=mixed --format=markdown --order=license | tee -a artifacts_python.md || {
            echo "pip-licenses fallback mode:" | tee -a artifacts_python.md
            pip-licenses --from=mixed --format=plain --order=license | tee -a artifacts_python.md
          }

      # --- è‡ªå‹•ãƒ†ã‚¹ãƒˆç”Ÿæˆï¼‹ã‚«ãƒãƒ¬ãƒƒã‚¸ ---
      - name: Auto test generation & mutation coverage
        run: |
          echo "" | tee -a artifacts_python.md
          echo "## ğŸ§ª Auto Test Generation & Mutation Coverage" | tee -a artifacts_python.md
          mkdir -p generated_tests

          # Pynguin ã§è‡ªå‹•ãƒ†ã‚¹ãƒˆç”Ÿæˆ
          python3 -m pynguin \
                  --project-path . \
                  --output-path generated_tests \
                  --coverage ${COVERAGE_LEVEL} 2>&1 | tee -a artifacts_python.md || echo "Auto test generation failed" | tee -a artifacts_python.md

          echo "" | tee -a artifacts_python.md
          echo "### Generated tests:" | tee -a artifacts_python.md
          find generated_tests -type f -name "test_*.py" | tee -a artifacts_python.md || echo "No tests generated" | tee -a artifacts_python.md

          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‹ã‚«ãƒãƒ¬ãƒƒã‚¸å‡ºåŠ›
          pytest generated_tests --cov=. --cov-branch -vv 2>&1 | tee -a artifacts_python.md || echo "Tests failed" | tee -a artifacts_python.md
          coverage report -m 2>&1 | tee -a artifacts_python.md || true

          # å¤‰ç•°ãƒ†ã‚¹ãƒˆ
          echo "" | tee -a artifacts_python.md
          echo "### ğŸ§¬ Mutation Analysis" | tee -a artifacts_python.md
          python3 -m mutpy --target . --unit-test generated_tests --report-html mutation_report --timeout-factor 0.3 2>&1 | tee -a artifacts_python.md || echo "Mutation analysis failed" | tee -a artifacts_python.md

      # --- UMLç”Ÿæˆ ---
      - name: Generate UML
        run: |
          echo "" | tee -a artifacts_python.md
          echo "## ğŸ§© UML Structure" | tee -a artifacts_python.md
          pyreverse -o dot -p ProjectName $(find . -name "*.py" -not -path "./venv/*" -not -path "./generated_tests/*") || true
          find . -name "*.dot" | tee -a artifacts_python.md

      # --- æˆæœç‰© ---
      - name: Upload reports
        uses: actions/upload-artifact@v3
        with:
          name: python-quality-intelligence
          path: |
            artifacts_python.md
            mutation_report/
            **/*.dot
