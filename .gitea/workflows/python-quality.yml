name: Python Quality Pipeline

on: [push]

jobs:
  python-quality:
    runs-on: ubuntu-latest

    env:
      COVERAGE_LEVEL: C1  # C0=å‘½ä»¤ç¶²ç¾…, C1=åˆ†å²ç¶²ç¾…, C2=æ¡ä»¶ç¶²ç¾…

    steps:
      # --- ç’°å¢ƒç¢ºèª ---
      - name: Check environment
        run: |
          echo "=== Runner Environment ==="
          env | grep GITEA || true
          echo ""
          echo "=== Working directory ==="
          pwd && ls -la

      # --- ã‚³ãƒ¼ãƒ‰å–å¾— ---
      - name: Checkout repository
        uses: actions/checkout@v3

      # --- ç’°å¢ƒæ§‹ç¯‰ ---
      - name: System setup
        run: |
          apt-get update -qq
          apt-get install -y python3-pip graphviz
          pip install --upgrade pip
          pip install pycodestats mypy bandit pytest pytest-cov coverage pylint graphviz pynguin pip-licenses

      # --- é™çš„è§£æï¼ˆPEP8, LOCï¼‰ ---
      - name: Static analysis (PEP8, LOC)
        run: |
          echo "## ğŸ§® Python Code Metrics" > artifacts_python.md
          pycodestats --by-file . >> artifacts_python.md

      # --- å‹ãƒã‚§ãƒƒã‚¯ ---
      - name: Type checking (mypy)
        run: |
          echo "" >> artifacts_python.md
          echo "## ğŸ§© Type Checking" >> artifacts_python.md
          mypy . >> artifacts_python.md 2>&1 || echo "Type check: failed or warnings" >> artifacts_python.md

      # --- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ ---
      - name: Security scan (bandit)
        run: |
          echo "" >> artifacts_python.md
          echo "## ğŸ”’ Security Scan" >> artifacts_python.md
          bandit -r . >> artifacts_python.md 2>&1 || echo "Security scan: issues detected" >> artifacts_python.md

      # --- ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ä¸€è¦§ ---
      - name: Dependency license scan (pip-licenses)
        run: |
          echo "" >> artifacts_python.md
          echo "## âš–ï¸ Dependency License Overview" >> artifacts_python.md
          pip-licenses --from=mixed --format=markdown --with-version --with-urls --order=license >> artifacts_python.md || echo "License scan failed" >> artifacts_python.md

      # --- è‡ªå‹•å˜ä½“ãƒ†ã‚¹ãƒˆç”Ÿæˆ ---
      - name: Auto-generate unit tests
        run: |
          echo "" >> artifacts_python.md
          echo "## ğŸ¤– Auto-Generated Unit Tests" >> artifacts_python.md
          mkdir -p generated_tests
          pynguin --project-path . --output-path ./generated_tests --module-name main || true
          echo "Generated test files:" >> artifacts_python.md
          find generated_tests -type f -name "test_*.py" >> artifacts_python.md || echo "No tests generated." >> artifacts_python.md

      # --- å˜ä½“ãƒ†ã‚¹ãƒˆï¼‹ã‚«ãƒãƒ¬ãƒƒã‚¸ ---
      - name: Unit test & coverage
        run: |
          echo "" >> artifacts_python.md
          echo "## ğŸ§ª Test & Coverage (${COVERAGE_LEVEL})" >> artifacts_python.md

          case "$COVERAGE_LEVEL" in
            C0) COVERAGE_ARGS="--cov --cov-branch=0" ;;   # å‘½ä»¤ç¶²ç¾…
            C1) COVERAGE_ARGS="--cov --cov-branch" ;;     # åˆ†å²ç¶²ç¾…
            C2) COVERAGE_ARGS="--cov --cov-branch --cov-context=test" ;; # æ¡ä»¶ç¶²ç¾…
            *)  COVERAGE_ARGS="--cov" ;;
          esac

          pytest generated_tests -vv --disable-warnings $COVERAGE_ARGS >> artifacts_python.md 2>&1 || echo "Tests failed or no coverage data" >> artifacts_python.md
          echo "" >> artifacts_python.md
          coverage report -m >> artifacts_python.md 2>&1 || true

      # --- çµæœè¡¨ç¤º ---
      - name: Display summary
        if: always()
        run: cat artifacts_python.md

      # --- UMLç”Ÿæˆ ---
      - name: Generate UML (DOT files)
        run: |
          pyreverse -o dot -p ProjectName $(find . -name "*.py" -not -path "./venv/*" -not -path "./tests/*" -not -path "./generated_tests/*")
          echo "Generated UML files:"
          find . -name "*.dot"

      # --- æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ---
      - name: Upload Python Quality Report
        uses: actions/upload-artifact@v3
        with:
          name: python-quality-report
          path: artifacts_python.md

      - name: Upload UML artifacts
        uses: actions/upload-artifact@v3
        with:
          name: uml-dot
          path: |
            **/classes_ProjectName.dot
            **/packages_ProjectName.dot
