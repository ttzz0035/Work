name: Python Quality Intelligence Pipeline

on: [push]

jobs:
  python-quality:
    runs-on: ubuntu-latest

    env:
      COVERAGE_LEVEL: C1  # C0=å‘½ä»¤ç¶²ç¾…, C1=åˆ†å²ç¶²ç¾…, C2=æ¡ä»¶ç¶²ç¾…

    steps:
      # --- ç’°å¢ƒç¢ºèª ---
      - name: Check environment
        run: |
          echo "=== Runner Environment ==="
          python3 --version
          which python3
          echo ""
          echo "=== Working directory ==="
          pwd && ls -la

      # --- ã‚³ãƒ¼ãƒ‰å–å¾— ---
      - name: Checkout repository
        uses: actions/checkout@v3

      # --- Pythonç’°å¢ƒæ§‹ç¯‰ ---
      - name: Setup Python Environment
        run: |
          apt-get update -qq
          apt-get install -y python3-pip graphviz licensecheck
          pip install --upgrade pip
          pip install pycodestats mypy bandit pytest pytest-cov coverage pylint graphviz pip-licenses reuse radon cyclonedx-bom

      # --- Pynguin ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆ3.9äº’æ›ï¼‹ãƒã‚°ä¿®æ­£ï¼‰ ---
      - name: Setup Pynguin (pre-patch for Python 3.9)
        run: |
          echo "" >> artifacts_python.md
          echo "## ğŸ§© Pynguin Installation (Pre-Patch for Python 3.9)" >> artifacts_python.md

          # --- 1ï¸âƒ£ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å±•é–‹å‰ã« site-packages ã‚’ç‰¹å®š ---
          SITE=$(python3 -c "import site; print(site.getsitepackages()[0])")
          echo "Site-packages: $SITE" >> artifacts_python.md

          # --- 2ï¸âƒ£ Compare.IN ãƒã‚°å¯¾ç­–ãƒ‘ãƒƒãƒã‚’äº‹å‰ç”Ÿæˆ ---
          mkdir -p "$SITE/pynguin/testcase"
          TARGET_FILES=(
            "$SITE/pynguin/testcase/execution.py"
            "$SITE/pynguin/testcase/executiontracer.py"
          )
          for FILE in "${TARGET_FILES[@]}"; do
            touch "$FILE"
            echo "# placeholder" > "$FILE"
          done

          # --- 3ï¸âƒ£ Pynguin 0.17.0 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ---
          pip install pynguin==0.17.0 pytest pytest-cov coverage graphviz >> artifacts_python.md 2>&1

          # --- 4ï¸âƒ£ Compare.Enum ã« IN ã‚’è¿½åŠ  ---
          for FILE in "${TARGET_FILES[@]}"; do
            if [ -f "$FILE" ]; then
              sed -i 's/class Compare(Enum):/class Compare(Enum):\n    IN = 999/' "$FILE" || true
              echo "Patched $FILE" >> artifacts_python.md
            fi
          done

          echo "âœ… Compare Enum patched before import" >> artifacts_python.md

      # --- ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆrequirements.txt ãŒã‚ã‚‹å ´åˆï¼‰ ---
      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # --- é™çš„ã‚³ãƒ¼ãƒ‰è§£æï¼ˆæ§‹æ–‡ãƒ»è¤‡é›‘åº¦ï¼‰ ---
      - name: Static code metrics
        run: |
          echo "## ğŸ§® Code Metrics & Complexity" > artifacts_python.md
          pycodestats --by-file . >> artifacts_python.md
          echo "" >> artifacts_python.md
          echo "### Cyclomatic Complexity (radon)" >> artifacts_python.md
          radon cc . -s -a >> artifacts_python.md 2>&1

      # --- å‹è§£æ ---
      - name: Type checking (mypy)
        run: |
          echo "" >> artifacts_python.md
          echo "## ğŸ§© Type Checking" >> artifacts_python.md
          mypy . >> artifacts_python.md 2>&1 || echo "Type check: warnings or failures" >> artifacts_python.md

      # --- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è§£æ ---
      - name: Security analysis (bandit)
        run: |
          echo "" >> artifacts_python.md
          echo "## ğŸ”’ Security Analysis" >> artifacts_python.md
          bandit -r . >> artifacts_python.md 2>&1 || echo "Security issues found" >> artifacts_python.md

      # --- è‡ªä½œã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è§£æ ---
      - name: In-repo license scan
        run: |
          echo "" >> artifacts_python.md
          echo "## âš–ï¸ Source License (Repository Files)" >> artifacts_python.md
          licensecheck --recursive --ignore ".git" . >> artifacts_python.md 2>&1 || echo "License header issues detected" >> artifacts_python.md
          echo "" >> artifacts_python.md
          echo "### SPDX Validation (reuse lint)" >> artifacts_python.md
          reuse lint >> artifacts_python.md 2>&1 || echo "SPDX lint: issues detected" >> artifacts_python.md

      # --- ä¾å­˜ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è§£æï¼ˆsite-packagesï¼‰ ---
      - name: Dependency license scan (pip-licenses)
        run: |
          echo "" >> artifacts_python.md
          echo "## âš–ï¸ Dependency Licenses (External Packages)" >> artifacts_python.md
          pip install --upgrade pip-licenses >/dev/null 2>&1
          pip-licenses --from=mixed --format=markdown --order=license >> artifacts_python.md 2>&1 || {
            echo "pip-licenses fallback mode:" >> artifacts_python.md
            pip-licenses --from=mixed --format=plain --order=license >> artifacts_python.md 2>&1
          }

      # --- è‡ªå‹•å˜ä½“ãƒ†ã‚¹ãƒˆç”Ÿæˆï¼‹ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š ---
      - name: Auto test generation & coverage
        run: |
          echo "" >> artifacts_python.md
          echo "## ğŸ§ª Auto Test Generation & Coverage" >> artifacts_python.md
          pynguin --project-path . --output-path generated_tests --coverage C1 >> artifacts_python.md 2>&1 || echo "Pynguin generation failed" >> artifacts_python.md
          echo "" >> artifacts_python.md
          echo "### Generated tests:" >> artifacts_python.md
          find generated_tests -name "test_*.py" >> artifacts_python.md || echo "No tests generated" >> artifacts_python.md
          pytest generated_tests --cov=. --cov-branch -vv >> artifacts_python.md 2>&1 || echo "pytest execution failed" >> artifacts_python.md
          coverage report -m >> artifacts_python.md 2>&1 || true

      # --- æ§‹é€ å›³ç”Ÿæˆï¼ˆUMLï¼‰ ---
      - name: Generate UML (pyreverse)
        run: |
          echo "" >> artifacts_python.md
          echo "## ğŸ§© UML Structure" >> artifacts_python.md
          pyreverse -o dot -p ProjectName $(find . -name "*.py" -not -path "./venv/*" -not -path "./generated_tests/*") || true
          find . -name "*.dot" >> artifacts_python.md

      # --- æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ---
      - name: Upload analysis report
        uses: actions/upload-artifact@v3
        with:
          name: python-quality-intel
          path: artifacts_python.md

      - name: Upload UML artifacts
        uses: actions/upload-artifact@v3
        with:
          name: uml-dot
          path: |
            **/classes_ProjectName.dot
            **/packages_ProjectName.dot
