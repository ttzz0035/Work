name: Python Quality Intelligence Pipeline

on: [push]

jobs:
  python-quality:
    runs-on: ubuntu-latest

    # Runnerä¾‹: python:3.10-bullseye
    env:
      COVERAGE_LEVEL: C1  # C0=å‘½ä»¤ç¶²ç¾…, C1=åˆ†å²ç¶²ç¾…, C2=æ¡ä»¶ç¶²ç¾…

    steps:
      # --- ç’°å¢ƒç¢ºèª ---
      - name: Environment Info
        run: |
          echo "=== ğŸ§  Python Environment Check ==="
          python3 --version
          which python3
          echo "Working dir: $(pwd)"
          ls -la

      # --- ã‚³ãƒ¼ãƒ‰å–å¾— ---
      - name: Checkout repository
        uses: actions/checkout@v3

      # --- ä¾å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
      - name: Setup Analysis Environment
        run: |
          apt-get update -qq
          apt-get install -y graphviz licensecheck
          pip install -U pip setuptools wheel
          pip install pycodestats mypy bandit pytest pytest-cov coverage pylint graphviz \
                     pip-licenses reuse radon cyclonedx-bom pynguin==0.25.2

          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # --- é™çš„èµ°æŸ»ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆå…±é€šãƒ™ãƒ¼ã‚¹ï¼‰ ---
      - name: Static File Scan
        run: |
          echo "## ğŸ” Static File Scan" | tee artifacts_python.md
          find . -type f -name "*.py" \
            -not -path "./venv/*" \
            -not -path "./generated_tests/*" > artifacts_filelist.txt
          cat artifacts_filelist.txt | tee -a artifacts_python.md

      # --- é™çš„ã‚³ãƒ¼ãƒ‰è§£æ ---
      - name: Static Code Metrics
        run: |
          echo "" | tee -a artifacts_python.md
          echo "## ğŸ§® Code Metrics & Complexity" | tee -a artifacts_python.md
          pycodestats --by-file . | tee -a artifacts_python.md
          echo "" | tee -a artifacts_python.md
          echo "### Cyclomatic Complexity (radon)" | tee -a artifacts_python.md
          radon cc . -s -a | tee -a artifacts_python.md

      # --- å‹è§£æ ---
      - name: Type Checking (mypy)
        run: |
          echo "" | tee -a artifacts_python.md
          echo "## ğŸ§© Type Checking" | tee -a artifacts_python.md
          mypy . | tee -a artifacts_python.md || echo "Type check: warnings or failures" | tee -a artifacts_python.md

      # --- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è§£æ ---
      - name: Security Analysis (bandit)
        run: |
          echo "" | tee -a artifacts_python.md
          echo "## ğŸ”’ Security Analysis" | tee -a artifacts_python.md
          bandit -r . | tee -a artifacts_python.md || echo "Security issues found" | tee -a artifacts_python.md

      # --- è‡ªä½œã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è§£æï¼ˆé™çš„ãƒªã‚¹ãƒˆä½¿ç”¨ï¼‰ ---
      - name: Source License Scan
        run: |
          echo "" | tee -a artifacts_python.md
          echo "## âš–ï¸ Source License (Repository Files)" | tee -a artifacts_python.md
          while read f; do
            licensecheck "$f" >> artifacts_python.md 2>&1 || true
          done < artifacts_filelist.txt
          echo "" | tee -a artifacts_python.md
          echo "### SPDX Validation (reuse lint)" | tee -a artifacts_python.md
          reuse lint | tee -a artifacts_python.md || echo "SPDX lint issues detected" | tee -a artifacts_python.md

      # --- ä¾å­˜ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è§£æ ---
      - name: Dependency License Scan
        run: |
          echo "" | tee -a artifacts_python.md
          echo "## âš–ï¸ Dependency Licenses (External Packages)" | tee -a artifacts_python.md
          pip-licenses --from=mixed --format=markdown --order=license | tee -a artifacts_python.md || {
            echo "pip-licenses fallback mode:" | tee -a artifacts_python.md
            pip-licenses --from=mixed --format=plain --order=license | tee -a artifacts_python.md
          }

      # --- è‡ªå‹•ãƒ†ã‚¹ãƒˆç”Ÿæˆï¼‹ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆå®‰å…¨importä»˜ãï¼‰ ---
      - name: Auto Test Generation & Coverage (Pynguin)
        run: |
          echo "" | tee -a artifacts_python.md
          echo "## ğŸ§ª Auto Test Generation & Coverage (Pynguin)" | tee -a artifacts_python.md
          mkdir -p generated_tests
          export PYNGUIN_DANGER_AWARE=1
          export PYTHONPATH=$(pwd)

          # --- å®‰å…¨importãƒ©ãƒƒãƒ‘ã‚’æŒ¿å…¥ã—ã¦å¤±æ•—é˜²æ­¢ ---
          echo "--- Patching __init__.py for safe imports ---"
          find . -name "__init__.py" -not -path "./venv/*" | while read init; do
            echo -e "\ntry:\n    import builtins\nexcept Exception: pass" >> "$init"
          done

          # --- Pynguinã§è‡ªå‹•ãƒ†ã‚¹ãƒˆç”Ÿæˆ ---
          while read f; do
            mod=$(echo "$f" | sed 's|^./||; s|/|.|g; s|.py$||')
            echo "--- Generating tests for: $mod ---" | tee -a artifacts_python.md
            python3 -m pynguin \
              --project-path . \
              --module-name "$mod" \
              --output-path generated_tests \
              --coverage-metrics BRANCH \
              --create-coverage-report true \
              --maximum-search-time 20 \
              --max-length-test-case 20 \
              --max-initial-tests 10 \
              --seed 42 >> artifacts_python.md 2>&1 || echo "Failed: $mod" | tee -a artifacts_python.md
          done < artifacts_filelist.txt

          echo "" | tee -a artifacts_python.md
          echo "### Generated Tests:" | tee -a artifacts_python.md
          find generated_tests -type f -name "test_*.py" | tee -a artifacts_python.md || echo "No tests generated" | tee -a artifacts_python.md

          echo "" | tee -a artifacts_python.md
          echo "--- Running Tests ---"
          # ãƒ­ã‚®ãƒ³ã‚°ç’°å¢ƒã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå‰å›ã®logãƒ†ã‚¹ãƒˆå¯¾ç­–ï¼‰
          python3 - <<'PY'
                      import logging
                      for h in logging.root.handlers[:]:
                          logging.root.removeHandler(h)
                      logging.basicConfig(level=logging.WARNING)
                      PY
          pytest generated_tests --cov=. --cov-branch -vv 2>&1 | tee -a artifacts_python.md || echo "Tests failed" | tee -a artifacts_python.md
          coverage report -m 2>&1 | tee -a artifacts_python.md || true
          
      # --- UMLç”Ÿæˆï¼ˆé™çš„ãƒªã‚¹ãƒˆåˆ©ç”¨ï¼ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ã®ã¿ï¼‰ ---
      - name: Generate UML (pyreverse)
        run: |
          echo "" | tee -a artifacts_python.md
          echo "## ğŸ§© UML Structure" | tee -a artifacts_python.md

          # é™çš„èµ°æŸ»ã§æŠ½å‡ºã—ãŸ .py ãƒ•ã‚¡ã‚¤ãƒ«ã«é™å®š
          echo "--- Generating UML .dot files ---" | tee -a artifacts_python.md
          xargs pyreverse -o dot -p ProjectName < artifacts_filelist.txt || true

          echo "" | tee -a artifacts_python.md
          echo "Generated .dot files:" | tee -a artifacts_python.md
          find . -name "*.dot" | tee -a artifacts_python.md

      # --- æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ---
      - name: Upload Reports
        uses: actions/upload-artifact@v3
        with:
          name: python-quality-intelligence
          path: |
            artifacts_python.md
            **/*.dot
